<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publicidad - AlphaSystems WiFi</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .progress-container { width: 100%; background-color: #e0e0e0; border-radius: 8px; margin: 20px 0; }
        .progress-bar { width: 0%; height: 20px; background-color: #4CAF50; border-radius: 8px; text-align: center; line-height: 20px; color: white; transition: width 0.1s linear; }
        .carousel-container { height: 250px; border: 1px solid #ddd; background-color: #f9f9f9; position: relative; overflow: hidden; }
        #carouselImage { width:100%; height:100%; object-fit: contain; }
    </style>
</head>
<body>
    <div class="container">
        <img src="recursos/maraplus.jpeg" alt="Logo MARAPLUS" class="logo">
        <div id="ad-content">
            <div class="carousel-container">
                <img id="carouselImage" src="" alt="Publicidad">
            </div>
            <p>Gracias por tu paciencia. El acceso a internet se habilitará en breve.</p>
            <div class="progress-container">
                <div id="progressBar" class="progress-bar">0%</div>
            </div>
        </div>
        <div id="success-content" style="display:none;">
            <h1>¡LISTO!</h1>
            <p>Ya tienes acceso a internet. Puedes cerrar esta ventana y empezar a navegar.</p>
        </div>
    </div>

    <script>
        // --- CÓDIGO DEL CARRUSEL Y PROGRESO (SIN CAMBIOS) ---
        const IMAGE_COUNT = 10; 
        const IMAGE_EXPOSURE_TIME = 3000;
        const TOTAL_TIME = IMAGE_COUNT * IMAGE_EXPOSURE_TIME;
        const PROGRESS_INTERVAL_TIME = 100;
        // ... (el resto del código del carrusel es el mismo) ...

        // --- LÓGICA DE AUTORIZACIÓN Y CAMBIO DE CONTENIDO ---
        function startAdPortal() {
            // ... (código del carrusel y progreso igual que antes) ...

            const progressInterval = setInterval(async () => { // <--- Hacemos esta función asíncrona
                progress += PROGRESS_INTERVAL_TIME;
                const percentage = Math.min(100, (progress / TOTAL_TIME) * 100);
                progressBar.style.width = percentage + '%';
                progressBar.textContent = Math.round(percentage) + '%';

                if (progress >= TOTAL_TIME) {
                    clearInterval(progressInterval);
                    clearInterval(carouselInterval);
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    const loginUrl = urlParams.get('login_url');
                    const mac = urlParams.get('mac');

                    if (loginUrl && mac) {
                        progressBar.textContent = 'Autorizando...';
                        
                        // --- ¡EL CAMBIO CLAVE! ---
                        // En lugar de redirigir, hacemos una petición fetch invisible
                        try {
                            const finalAuthUrl = `${loginUrl}?user=${encodeURIComponent(mac)}&pws=google_ok`;
                            
                            // El modo 'no-cors' es crucial para que el navegador no bloquee la petición
                            // aunque no podamos leer la respuesta, la petición se envía y el AP la recibe.
                            await fetch(finalAuthUrl, { mode: 'no-cors' });
                            
                            // Si la petición se envió, mostramos el mensaje de éxito
                            document.getElementById('ad-content').style.display = 'none';
                            document.getElementById('success-content').style.display = 'block';

                        } catch (error) {
                            // Este catch es por si el fetch mismo falla, no por la respuesta
                            progressBar.style.backgroundColor = 'red';
                            progressBar.textContent = 'Error de conexión con el AP.';
                            console.error("Error en el fetch de autorización:", error);
                        }
                    } else {
                        progressBar.style.backgroundColor = 'red';
                        progressBar.textContent = 'Error: Faltan parámetros AP.';
                    }
                }
            }, PROGRESS_INTERVAL_TIME);
        }

        window.onload = startAdPortal;
    </script>
</body>
</html>
